<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>

    <script>
        osql.requireLogin();

        var me;
        var roomId = osql.getParam('roomId');

        $(document).ready(async function () {
            var sql1 = `select * from Participations where roomId = ${roomId}`
            var object = await osql.connect(sql1);
            if (object.length < 2) {

                me = await osql.getMe();
                document.getElementById('firstname').innerHTML = me.fname;
                document.getElementById('lastname').innerHTML = me.lname;

                var sql = `select * from Rooms where id = ${roomId};`;
                var objects = await osql.connect(sql);

                var room = objects[0];
                document.getElementById('roomname').innerHTML = room.name;

                insertParticipation();
                await refreshUsers();
                await movegame();
                setInterval(refreshUsers, 200);
                setInterval(movegame, 200);
            } else {
                document.getElementById('members').innerHTML = '満員です';
            }
        });

        async function insertParticipation() {
            var me = await osql.getMe();
            var sql = `select * from Participations where userId = '${me.id}'`
            var sql1 = `select * from Participations where roomId = ${roomId}`
            var object2 = await osql.connect(sql);
            var object = await osql.connect(sql1);
            if (object2.length == 0) {
                var order = object.length + 1;
                var sql2 = `insert into Participations (userId, orders, roomId) values ('${me.id}', ${order}, ${roomId})`;
                var participationId = await osql.connectInsert(sql2);
            } else {
                var sql = `delete from Participations where userId = '${me.id}'`;
                var commentId = await osql.connect(sql);
                var order = object.length + 1;
                var sql2 = `insert into Participations (userId, orders, roomId) values ('${me.id}', ${order}, ${roomId})`;
                var participationId = await osql.connectInsert(sql2);
            }
        }

        async function refreshUsers() {
            var sql = `select * from Users inner join Participations on Users.id = Participations.userId where Participations.roomId = ${roomId};`;
            var objects = await osql.connect(sql);
            console.log(objects);
            var html = '';
            for (var i = 0; i < objects.length; i++) {
                var object = objects[i];
                html = html + object.fname;
                html = html + object.lname;
                html = html + '<br>'
            }
            document.getElementById('members').innerHTML = html;
        }

        async function exitgame() {
            me = await osql.getMe();
            var sql = `delete from Participations where userId = '${me.id}'`;
            var commentId = await osql.connect(sql);
            window.location.replace('index.html');
        }

        async function Start() {
            var sql3 = `update Rooms set turn = 0 where id =${roomId}`;
            await osql.connect(sql3);
        }

        async function movegame() {
            var sql = `select * from Rooms where id = ${roomId}`;
            var objects = await osql.connect(sql);
            var turn = objects[0].turn;
            if (turn == 0) {
                window.location.href = `game.html?roomId=${roomId}`
            }
        }

    </script>


    </script>

</head>

<body>
    <h1>Game:<span id="roomname"></span></h1>
    <div style="text-align: right;">
        ようこそ<span id="lastname"></span> <span id="firstname"></span>さん
        <button onclick="exitgame()">退出</button>
    </div>
    <hr>
    <br>
    メンバー
    <div id="members"></div>
    <hr>
    <button id="start" onclick="Start()">始める</button>
</body>

</html>